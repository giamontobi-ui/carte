<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Serate Carte üÉè</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --primary: #3b82f6;
      --success: #22c55e;
      --danger: #ef4444;
      --accent: #8b5cf6;
      --accent2: #f43f5e;
      --border: #334155;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      padding-bottom: 40px;
    }
    header {
      background: var(--panel);
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    h1 { margin: 0; font-size: 1.5rem; }
    h2, h3 { color: var(--text); margin-top: 0; }
    nav { display: flex; gap: 8px; }
    .tab {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }
    .panel {
      background: var(--panel);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }
    .btn {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: white; }
    .btn.success { background: var(--success); border-color: var(--success); color: white; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .col-6 { flex: 1; min-width: 200px; }
    .grid { display: flex; gap: 16px; flex-wrap: wrap; }
    .field { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
    input, select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      border-radius: 6px;
      font-size: 16px;
    }
    .list { display: flex; flex-direction: column; gap: 12px; }
    .item {
      background: var(--bg);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .badge {
      background: var(--border);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .chip {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 14px;
    }
    .winner { color: var(--success); font-weight: bold; }
    .table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
    .table th, .table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .table th { color: var(--muted); font-size: 14px; white-space: nowrap; }
    .table td:first-child, .table th:first-child { padding-left: 4px; }
    .medal {
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      border-radius: 50%;
      background: var(--border);
      font-size: 12px;
    }
    .rank-1 .medal { background: #fbbf24; color: #78350f; }
    .rank-2 .medal { background: #94a3b8; color: #0f172a; }
    .rank-3 .medal { background: #b45309; color: #fffbeb; }
    .mono { font-family: monospace; }
    .muted { color: var(--muted); }
    .divider { height: 1px; background: var(--border); margin: 16px 0; }
    .footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 32px; }
    
    @media (max-width: 600px) {
      .col-6 { min-width: 100%; }
      .table { font-size: 14px; }
    }
  </style>
  <script>
    window.onerror = function(msg, url, line) {
      alert("Errore JS: " + msg + " (Riga " + line + ")");
    };
  </script>
</head>
<body>
  <header>
    <h1>Serate Carte üÉè</h1>
    <nav>
      <button class="tab active" data-tab="home">üè† Home</button>
      <button class="tab" data-tab="new">‚ûï Nuova Serata</button>
      <button class="tab" data-tab="stats">üìä Statistiche</button>
    </nav>
  </header>
  <div class="container">
    <section id="home" class="panel">
      <div class="row" style="justify-content: space-between;">
        <h2>Serate</h2>
        <div class="row">
          <span class="badge" id="count-serate">0 serate</span>
          <button class="btn primary" id="btn-add-serata-home">+ Aggiungi serata</button>
        </div>
      </div>
      <div id="serate-list" class="list"></div>
      <div id="serate-empty" class="empty" style="display:none">Nessuna serata registrata</div>
    </section>

    <section id="new" class="panel" style="display:none">
      <h2>Nuova Serata</h2>
      <div class="grid">
        <div class="col-6">
          <div class="field">
            <label>Data</label>
            <input type="date" id="date-input">
          </div>
        </div>
        <div class="col-6">
          <div class="field">
            <label>Coppie</label>
            <div class="row">
              <button class="btn" id="btn-shuffle">Genera coppie casuali</button>
              <span class="badge" id="pairs-hint">Alfredo, Ermi, Gian Luca, Massimo</span>
            </div>
            <div class="row">
              <span id="pairA" class="pair"></span>
              <span class="muted">vs</span>
              <span id="pairB" class="pair"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <h3>Giochi</h3>
      <div id="games-form" class="list"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn success" id="btn-save" disabled>Salva serata</button>
        <span id="save-status" class="muted"></span>
      </div>
    </section>

    <section id="stats" class="panel" style="display:none">
      <div class="row" style="justify-content: space-between;">
        <h2>Statistiche Annuali</h2>
        <div class="field" style="min-width: 200px">
          <label>Anno</label>
          <select id="year-select"></select>
        </div>
      </div>
      <div class="divider"></div>

      <h3>Classifica principale: vincitori serate (giocatori)</h3>
      <table class="table" id="table-player-evening"></table>

      <h3>Classifica giocatori: giochi totali vinti</h3>
      <table class="table" id="table-player-gamepoints"></table>

      <h3>Vittorie / Sconfitte per coppia</h3>
      <table class="table" id="table-wl"></table>

      <h3>Classifiche per singolo gioco (giocatori)</h3>
      <div id="per-game-stats" class="list"></div>

      <h3>Cronologia Punteggi</h3>
      <div style="overflow-x:auto">
        <table class="table" id="table-history"></table>
      </div>

      <h3>Statistica Punteggi</h3>
      <table class="table" id="table-scores" style="max-width:300px"></table>
      
      <div class="divider"></div>
      <div class="row" style="margin-top:20px">
        <button class="btn success" id="btn-stats-report">Report Classifiche WhatsApp</button>
      </div>
    </section>

    <div class="footer">Dati salvati solo su questo dispositivo</div>
  </div>

  <script>
    const PLAYERS = ["Alfredo","Ermi","Gian Luca","Massimo"];
    const BASE_GAMES = ["Briscola","Tressette","Scopone","Trionfo","Pinacolo","Marianna"];
    const ALT_GAMES = ["Scopa 15","Strappetto"];
    const STORAGE_KEY = "serate_brisc_tre_data_v1";

    const tabs = Array.from(document.querySelectorAll(".tab"));
    const sections = {
      home: document.getElementById("home"),
      new: document.getElementById("new"),
      stats: document.getElementById("stats"),
    };

    function setActiveTab(id) {
      tabs.forEach(t => t.classList.toggle("active", (t.dataset.tab === id)));
      Object.entries(sections).forEach(([k, el]) => el.style.display = (k === id ? "" : "none"));
      if (id === "home") renderHome();
      if (id === "new") renderNew();
      if (id === "stats") renderStats();
    }
    tabs.forEach(t => {
      t.addEventListener("click", () => setActiveTab(t.dataset.tab));
    });
    // Gestione esplicita del bottone "Aggiungi serata" nella home
    const btnAddHome = document.getElementById("btn-add-serata-home");
    if (btnAddHome) {
      btnAddHome.addEventListener("click", () => setActiveTab("new"));
    }

    function loadSerate() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        if (!Array.isArray(data)) return [];
        return data.map(s => ({...s}));
      } catch {
        return [];
      }
    }
    function saveSerate(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }
    function uid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
    function formatDateISO(d) {
      return d.toISOString().slice(0,10);
    }
    function parseDateInput(val) {
      const parts = val.split("-");
      if (parts.length !== 3) return null;
      const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
      if (isNaN(d.getTime())) return null;
      return d;
    }
    function pairLabel(pair) {
      return pair.join(" + ");
    }
    function pairKey(pair) {
      return [...pair].sort().join(" + ");
    }
    function countPointsForSerata(serata) {
      const counts = { A: 0, B: 0 };
      serata.games.forEach(g => {
        if (g.winner === "A") counts.A += 1;
        if (g.winner === "B") counts.B += 1;
      });
      return counts;
    }
    function eveningWinner(serata) {
      const c = countPointsForSerata(serata);
      if (c.A > c.B) return "A";
      if (c.B > c.A) return "B";
      return null;
    }
    function normalizeGamesSelection(selectedAlt) {
      const names = [...BASE_GAMES, selectedAlt];
      return names;
    }

    function renderHome() {
      const list = loadSerate().sort((a,b) => b.date.localeCompare(a.date));
      document.getElementById("count-serate").textContent = `${list.length} serate`;
      const container = document.getElementById("serate-list");
      const empty = document.getElementById("serate-empty");
      container.innerHTML = "";
      empty.style.display = list.length ? "none" : "";
      list.forEach(serata => {
        const c = countPointsForSerata(serata);
        const winner = eveningWinner(serata);
        const root = document.createElement("div");
        root.className = "item";
        const dateEl = document.createElement("div");
        dateEl.className = "mono";
        const d = parseDateInput(serata.date);
        dateEl.textContent = d ? d.toLocaleDateString("it-IT") : serata.date;
        const pairsEl = document.createElement("div");
        pairsEl.innerHTML = `
          <div class="row">
            <span class="chip">${pairLabel(serata.pairA)}</span>
            <span class="muted">(${c.A})</span>
          </div>
          <div class="row">
            <span class="chip">${pairLabel(serata.pairB)}</span>
            <span class="muted">(${c.B})</span>
          </div>
        `;
        const winEl = document.createElement("div");
        winEl.innerHTML = winner
          ? `<span class="winner">üèÜ ${winner === "A" ? pairLabel(serata.pairA) : pairLabel(serata.pairB)}</span>`
          : `<span class="badge">Pareggio</span>`;
        const actions = document.createElement("div");
        const btnReport = document.createElement("button");
        btnReport.className = "btn";
        btnReport.textContent = "Report WhatsApp";
        btnReport.addEventListener("click", () => openReportModal(serata));
        const btnDelete = document.createElement("button");
        btnDelete.className = "btn danger";
        btnDelete.textContent = "Elimina";
        btnDelete.addEventListener("click", () => {
          const ok = confirm("Eliminare questa serata?");
          if (!ok) return;
          const all = loadSerate().filter(s => s.id !== serata.id);
          saveSerate(all);
          renderHome();
        });
        actions.appendChild(btnReport);
        actions.appendChild(btnDelete);
        root.appendChild(dateEl);
        root.appendChild(pairsEl);
        root.appendChild(winEl);
        root.appendChild(actions);
        container.appendChild(root);
      });
    }

    let currentAlt = ALT_GAMES[0];
    let currentPairs = { A: null, B: null };
    function renderNew() {
      const dInput = document.getElementById("date-input");
      if (!dInput.value) dInput.value = formatDateISO(new Date());
      document.getElementById("btn-shuffle").onclick = () => {
        const shuffled = [...PLAYERS].sort(() => Math.random() - 0.5);
        currentPairs.A = [shuffled[0], shuffled[1]];
        currentPairs.B = [shuffled[2], shuffled[3]];
        document.getElementById("pairA").textContent = pairLabel(currentPairs.A);
        document.getElementById("pairB").textContent = pairLabel(currentPairs.B);
        validateCanSave();
      };
      const form = document.getElementById("games-form");
      form.innerHTML = "";
      const altWrap = document.createElement("div");
      altWrap.className = "field";
      const altLabel = document.createElement("label");
      altLabel.textContent = "Gioco alternativo";
      const altSelect = document.createElement("select");
      ALT_GAMES.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        altSelect.appendChild(opt);
      });
      altSelect.value = currentAlt;
      altSelect.addEventListener("change", () => {
        currentAlt = altSelect.value;
        renderGamesRadios();
      });
      altWrap.appendChild(altLabel);
      altWrap.appendChild(altSelect);
      form.appendChild(altWrap);
      const radiosWrap = document.createElement("div");
      form.appendChild(radiosWrap);
      function renderGamesRadios() {
        radiosWrap.innerHTML = "";
        const gameNames = normalizeGamesSelection(currentAlt);
        gameNames.forEach(name => {
          const row = document.createElement("div");
          row.className = "item";
          const gameTitle = document.createElement("div");
          gameTitle.textContent = name;
          const radios = document.createElement("div");
          radios.className = "radio-group";
          const aId = `g_${name}_A`;
          const bId = `g_${name}_B`;
          const aLabel = document.createElement("label");
          const aInput = document.createElement("input");
          aInput.type = "radio";
          aInput.name = `g_${name}`;
          aInput.id = aId;
          aInput.value = "A";
          aLabel.htmlFor = aId;
          aLabel.textContent = pairLabel(currentPairs.A || ["Coppia A","",""].slice(0,2));
          const bLabel = document.createElement("label");
          const bInput = document.createElement("input");
          bInput.type = "radio";
          bInput.name = `g_${name}`;
          bInput.id = bId;
          bInput.value = "B";
          bLabel.htmlFor = bId;
          bLabel.textContent = pairLabel(currentPairs.B || ["Coppia B","",""].slice(0,2));
          [aInput, bInput].forEach(el => el.addEventListener("change", validateCanSave));
          const aWrap = document.createElement("div");
          aWrap.className = "row";
          aWrap.appendChild(aInput);
          aWrap.appendChild(aLabel);
          const bWrap = document.createElement("div");
          bWrap.className = "row";
          bWrap.appendChild(bInput);
          bWrap.appendChild(bLabel);
          radios.appendChild(aWrap);
          radios.appendChild(bWrap);
          row.appendChild(gameTitle);
          row.appendChild(radios);
          radiosWrap.appendChild(row);
        });
      }
      renderGamesRadios();
      document.getElementById("btn-save").onclick = saveSerataFromForm;
      validateCanSave();
    }
    function validateCanSave() {
      const dateVal = document.getElementById("date-input").value;
      const hasDate = !!parseDateInput(dateVal);
      const hasPairs = !!(currentPairs.A && currentPairs.B);
      const gameNames = normalizeGamesSelection(currentAlt);
      const allSelected = gameNames.every(name => {
        const sel = document.querySelector(`input[name="g_${name}"]:checked`);
        return !!sel;
      });
      document.getElementById("btn-save").disabled = !(hasDate && hasPairs && allSelected);
      document.getElementById("save-status").textContent = !(hasDate && hasPairs)
        ? "Seleziona data e genera coppie"
        : (!allSelected ? "Seleziona i vincitori di tutti i giochi" : "");
    }
    function saveSerataFromForm() {
      const dateVal = document.getElementById("date-input").value;
      const games = normalizeGamesSelection(currentAlt).map(name => {
        const sel = document.querySelector(`input[name="g_${name}"]:checked`);
        return { name, winner: sel ? sel.value : null };
      });
      const serata = {
        id: uid(),
        date: dateVal,
        pairA: currentPairs.A,
        pairB: currentPairs.B,
        games
      };
      const all = loadSerate();
      all.push(serata);
      saveSerate(all);
      setActiveTab("home");
    }

    function ensureYearSelectYears() {
      const years = new Set();
      const all = loadSerate();
      all.forEach(s => {
        const d = parseDateInput(s.date);
        const y = d ? d.getFullYear() : new Date().getFullYear();
        years.add(y);
      });
      if (!years.size) years.add(new Date().getFullYear());
      const arr = Array.from(years).sort((a,b) => b - a);
      const sel = document.getElementById("year-select");
      const prev = sel.value;
      sel.innerHTML = "";
      arr.forEach(y => {
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      });
      sel.value = prev && arr.includes(Number(prev)) ? prev : String(arr[0]);
      sel.onchange = () => renderStatsTables();
    }
    function renderStats() {
      ensureYearSelectYears();
      renderStatsTables();
    }
    function filterByYear(list, year) {
      return list.filter(s => {
        const d = parseDateInput(s.date);
        return (d ? d.getFullYear() : new Date().getFullYear()) === year;
      });
    }
    function computePairTotalsByYear(year) {
      const all = filterByYear(loadSerate(), year);
      const totals = {};
      const wl = {};
      const eveningWins = {};
      const perGame = {};
      const playerEveningWins = {};
      const playerGamePoints = {};
      const perGamePlayers = {};
      const gameNames = [...BASE_GAMES, ...ALT_GAMES];
      gameNames.forEach(n => { perGame[n] = {}; perGamePlayers[n] = {}; });
      all.forEach(s => {
        const keyA = pairKey(s.pairA);
        const keyB = pairKey(s.pairB);
        if (!(keyA in totals)) totals[keyA] = 0;
        if (!(keyB in totals)) totals[keyB] = 0;
        const c = countPointsForSerata(s);
        totals[keyA] += c.A;
        totals[keyB] += c.B;
        if (!(keyA in wl)) wl[keyA] = { win: 0, loss: 0 };
        if (!(keyB in wl)) wl[keyB] = { win: 0, loss: 0 };
        const w = eveningWinner(s);
        if (w === "A") { wl[keyA].win += 1; wl[keyB].loss += 1; }
        if (w === "B") { wl[keyB].win += 1; wl[keyA].loss += 1; }
        if (!(keyA in eveningWins)) eveningWins[keyA] = 0;
        if (!(keyB in eveningWins)) eveningWins[keyB] = 0;
        if (w === "A") eveningWins[keyA] += 1;
        if (w === "B") eveningWins[keyB] += 1;
        if (w === "A") {
          s.pairA.forEach(p => { playerEveningWins[p] = (playerEveningWins[p] || 0) + 1; });
        } else if (w === "B") {
          s.pairB.forEach(p => { playerEveningWins[p] = (playerEveningWins[p] || 0) + 1; });
        }
        s.games.forEach(g => {
          if (!(g.name in perGame)) perGame[g.name] = {};
          const winKey = g.winner === "A" ? keyA : (g.winner === "B" ? keyB : null);
          if (winKey) {
            if (!(winKey in perGame[g.name])) perGame[g.name][winKey] = 0;
            perGame[g.name][winKey] += 1;
            const winners = g.winner === "A" ? s.pairA : s.pairB;
            winners.forEach(p => {
              playerGamePoints[p] = (playerGamePoints[p] || 0) + 1;
              perGamePlayers[g.name][p] = (perGamePlayers[g.name][p] || 0) + 1;
            });
          }
        });
      });
      return { totals, wl, eveningWins, perGame, playerEveningWins, playerGamePoints, perGamePlayers };
    }

    function renderHistoryTable(year) {
      const list = filterByYear(loadSerate(), year).sort((a,b) => a.date.localeCompare(b.date));
      const table = document.getElementById("table-history");
      table.innerHTML = "";
      
      const thead = document.createElement("thead");
      let headHtml = "<tr><th>Data</th>";
      PLAYERS.forEach(p => headHtml += `<th style="text-align:center">${p}</th>`);
      headHtml += "</tr>";
      thead.innerHTML = headHtml;
      
      const tbody = document.createElement("tbody");
      list.forEach(s => {
        const c = countPointsForSerata(s);
        const w = eveningWinner(s);
        const tr = document.createElement("tr");
        
        const tdDate = document.createElement("td");
        tdDate.className = "mono";
        const d = parseDateInput(s.date);
        tdDate.textContent = d ? d.toLocaleDateString("it-IT", {day: "2-digit", month: "2-digit"}) : s.date;
        if (d) tdDate.title = d.toLocaleDateString("it-IT"); 
        tr.appendChild(tdDate);

        PLAYERS.forEach(p => {
          const td = document.createElement("td");
          td.style.textAlign = "center";
          td.style.fontWeight = "bold";
          
          let points = 0;
          let isWinner = false;
          let isLoser = false;
          
          if (s.pairA.includes(p)) {
            points = c.A;
            if (w === "A") isWinner = true;
            if (w === "B") isLoser = true;
          } else if (s.pairB.includes(p)) {
            points = c.B;
            if (w === "B") isWinner = true;
            if (w === "A") isLoser = true;
          }
          
          td.textContent = points;
          if (isWinner) {
            td.style.backgroundColor = "rgba(34, 197, 94, 0.2)";
            td.style.color = "#166534";
          } else if (isLoser) {
            td.style.backgroundColor = "rgba(239, 68, 68, 0.2)";
            td.style.color = "#991b1b";
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);
    }

    function renderScoreStats(year) {
      const list = filterByYear(loadSerate(), year);
      const counts = { "7-0": 0, "6-1": 0, "5-2": 0, "4-3": 0 };
      
      list.forEach(s => {
        const c = countPointsForSerata(s);
        const max = Math.max(c.A, c.B);
        const min = Math.min(c.A, c.B);
        const key = `${max}-${min}`;
        if (counts[key] !== undefined) counts[key]++;
      });
      
      const table = document.getElementById("table-scores");
      table.innerHTML = "";
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Punteggio</th><th>N. Serate</th></tr>";
      const tbody = document.createElement("tbody");
      Object.keys(counts).forEach(k => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${k}</td><td>${counts[k]}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(thead);
      table.appendChild(tbody);
    }

    function renderStatsTables() {
      const year = Number(document.getElementById("year-select").value);
      const { wl, playerEveningWins, playerGamePoints, perGamePlayers } = computePairTotalsByYear(year);
      
      const sessionsList = filterByYear(loadSerate(), year).sort((a,b) => a.date.localeCompare(b.date));
      const scoreCounts = { "7-0": 0, "6-1": 0, "5-2": 0, "4-3": 0 };
      sessionsList.forEach(s => {
         const c = countPointsForSerata(s);
         const max = Math.max(c.A, c.B);
         const min = Math.min(c.A, c.B);
         const key = `${max}-${min}`;
         if (scoreCounts[key] !== undefined) scoreCounts[key]++;
      });

      window.currentStatsData = { year, playerEveningWins, playerGamePoints, perGamePlayers, sessionsList, scoreCounts };
      
      const wlArr = Object.entries(wl).map(([key, obj]) => ({ key, ...obj }))
        .sort((a,b) => (b.win - a.win) || (a.loss - b.loss));
      const pevTable = document.getElementById("table-player-evening");
      pevTable.innerHTML = "";
      const pevHead = document.createElement("thead");
      pevHead.innerHTML = "<tr><th>Pos.</th><th>Giocatore</th><th>Punti serate</th></tr>";
      const pevBody = document.createElement("tbody");
      const pevRows = Object.entries(playerEveningWins).map(([player, pts]) => ({ player, pts }))
        .sort((a,b) => b.pts - a.pts);
      pevRows.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.className = i < 3 ? `rank-${i+1}` : "";
        tr.innerHTML = `<td><span class="medal">${i+1}</span></td><td>${row.player}</td><td>${row.pts}</td>`;
        pevBody.appendChild(tr);
      });
      if (pevRows.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.className = "muted";
        td.textContent = "Nessun dato";
        tr.appendChild(td);
        pevBody.appendChild(tr);
      }
      pevTable.appendChild(pevHead);
      pevTable.appendChild(pevBody);
      const pgpTable = document.getElementById("table-player-gamepoints");
      pgpTable.innerHTML = "";
      const pgpHead = document.createElement("thead");
      pgpHead.innerHTML = "<tr><th>Pos.</th><th>Giocatore</th><th>Giochi totali vinti</th></tr>";
      const pgpBody = document.createElement("tbody");
      const pgpRows = Object.entries(playerGamePoints).map(([player, pts]) => ({ player, pts }))
        .sort((a,b) => b.pts - a.pts);
      pgpRows.forEach((row, i) => {
        const tr = document.createElement("tr");
        tr.className = i < 3 ? `rank-${i+1}` : "";
        tr.innerHTML = `<td><span class="medal">${i+1}</span></td><td>${row.player}</td><td>${row.pts}</td>`;
        pgpBody.appendChild(tr);
      });
      if (pgpRows.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.className = "muted";
        td.textContent = "Nessun dato";
        tr.appendChild(td);
        pgpBody.appendChild(tr);
      }
      pgpTable.appendChild(pgpHead);
      pgpTable.appendChild(pgpBody);
      const wlTable = document.getElementById("table-wl");
      wlTable.innerHTML = "";
      const wlHead = document.createElement("thead");
      wlHead.innerHTML = "<tr><th>Coppia</th><th>Serate vinte</th><th>Serate perse</th></tr>";
      const wlBody = document.createElement("tbody");
      wlArr.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.key}</td><td>${row.win}</td><td>${row.loss}</td>`;
        wlBody.appendChild(tr);
      });
      wlTable.appendChild(wlHead);
      wlTable.appendChild(wlBody);
      const perGameWrap = document.getElementById("per-game-stats");
      perGameWrap.innerHTML = "";
      const allGameNames = [...BASE_GAMES, ...ALT_GAMES];
      allGameNames.forEach(name => {
        const panel = document.createElement("div");
        panel.className = "panel";
        const title = document.createElement("h3");
        title.textContent = name;
        const table = document.createElement("table");
        table.className = "table";
        const head = document.createElement("thead");
        head.innerHTML = "<tr><th>Pos.</th><th>Giocatore</th><th>Serate vinte in questo gioco</th></tr>";
        const body = document.createElement("tbody");
        const rows = Object.entries(perGamePlayers[name] || {}).map(([player, pts]) => ({ player, pts }))
          .sort((a,b) => b.pts - a.pts);
        if (rows.length === 0) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 3;
          td.className = "muted";
          td.textContent = "Nessun dato";
          tr.appendChild(td);
          body.appendChild(tr);
        } else {
          rows.forEach((row, i) => {
            const tr = document.createElement("tr");
            tr.className = i < 3 ? `rank-${i+1}` : "";
            tr.innerHTML = `<td><span class="medal">${i+1}</span></td><td>${row.player}</td><td>${row.pts}</td>`;
            body.appendChild(tr);
          });
        }
        table.appendChild(head);
        table.appendChild(body);
        panel.appendChild(title);
        panel.appendChild(table);
        perGameWrap.appendChild(panel);
      });
      
      renderHistoryTable(year);
      renderScoreStats(year);
    }

    function openStatsReportModal() {
      if (!window.currentStatsData) return;
      const { year, playerEveningWins, playerGamePoints, perGamePlayers, sessionsList, scoreCounts } = window.currentStatsData;
      const lines = [];
      lines.push(`üìä Classifiche ${year} üìä`);
      lines.push("");
      lines.push("üèÜ Vincitori Serate");
      const pevRows = Object.entries(playerEveningWins).map(([player, pts]) => ({ player, pts })).sort((a,b) => b.pts - a.pts);
      if (pevRows.length === 0) lines.push("- Nessun dato");
      else pevRows.forEach((row, i) => lines.push(`${i+1}. ${row.player}: ${row.pts}`));
      lines.push("");
      lines.push("üéÆ Giochi Totali Vinti");
      const pgpRows = Object.entries(playerGamePoints).map(([player, pts]) => ({ player, pts })).sort((a,b) => b.pts - a.pts);
      if (pgpRows.length === 0) lines.push("- Nessun dato");
      else pgpRows.forEach((row, i) => lines.push(`${i+1}. ${row.player}: ${row.pts}`));
      lines.push("");
      lines.push("üéØ Singoli Giochi (Top 4)");
      const allGameNames = [...BASE_GAMES, ...ALT_GAMES];
      allGameNames.forEach(name => {
        const rows = Object.entries(perGamePlayers[name] || {}).map(([player, pts]) => ({ player, pts })).sort((a,b) => b.pts - a.pts);
        lines.push(`- ${name}`);
        if (rows.length === 0) {
          lines.push("  Nessun dato");
        } else {
          rows.slice(0,4).forEach((row, i) => {
            lines.push(`  ${i+1}. ${row.player}: ${row.pts}`);
          });
        }
      });
      lines.push("");
      
      lines.push("üìÖ Cronologia Punteggi");
      if (!sessionsList || sessionsList.length === 0) {
        lines.push("- Nessun dato");
      } else {
        sessionsList.forEach(s => {
          const d = parseDateInput(s.date);
          const dateStr = d ? d.toLocaleDateString("it-IT").slice(0,5) : s.date;
          const c = countPointsForSerata(s);
          const w = eveningWinner(s);
          
          const parts = PLAYERS.map(p => {
            let pts = 0;
            let isWin = false;
            if (s.pairA.includes(p)) { pts = c.A; if (w === "A") isWin = true; }
            else if (s.pairB.includes(p)) { pts = c.B; if (w === "B") isWin = true; }
            return isWin ? `*${p}(${pts})*` : `${p}(${pts})`;
          });
          lines.push(`${dateStr}: ${parts.join(" ")}`);
        });
      }
      lines.push("");

      lines.push("üìà Statistica Punteggi");
      if (scoreCounts) {
        Object.keys(scoreCounts).forEach(k => {
          lines.push(`${k}: ${scoreCounts[k]}`);
        });
      }

      const text = lines.join("\n");
      
      const visualContainer = document.createElement("div");
      
      const hTitle = document.createElement("h2");
      hTitle.textContent = `üìä Classifiche ${year}`;
      hTitle.style.textAlign = "center";
      visualContainer.appendChild(hTitle);

      const hWin = document.createElement("h3");
      hWin.textContent = "üèÜ Vincitori Serate";
      visualContainer.appendChild(hWin);
      const ulWin = document.createElement("ul");
      if (pevRows.length === 0) ulWin.innerHTML = "<li>Nessun dato</li>";
      else pevRows.forEach((row, i) => {
        const li = document.createElement("li");
        li.textContent = `${i+1}. ${row.player}: ${row.pts}`;
        ulWin.appendChild(li);
      });
      visualContainer.appendChild(ulWin);

      const hGames = document.createElement("h3");
      hGames.textContent = "üéÆ Giochi Totali Vinti";
      visualContainer.appendChild(hGames);
      const ulGames = document.createElement("ul");
      if (pgpRows.length === 0) ulGames.innerHTML = "<li>Nessun dato</li>";
      else pgpRows.forEach((row, i) => {
        const li = document.createElement("li");
        li.textContent = `${i+1}. ${row.player}: ${row.pts}`;
        ulGames.appendChild(li);
      });
      visualContainer.appendChild(ulGames);

      const hSingle = document.createElement("h3");
      hSingle.textContent = "üéØ Singoli Giochi (Top 4)";
      visualContainer.appendChild(hSingle);
      allGameNames.forEach(name => {
        const rows = Object.entries(perGamePlayers[name] || {}).map(([player, pts]) => ({ player, pts })).sort((a,b) => b.pts - a.pts);
        const p = document.createElement("div");
        p.style.fontWeight = "bold";
        p.style.marginTop = "8px";
        p.textContent = name;
        visualContainer.appendChild(p);
        const ul = document.createElement("ul");
        ul.style.marginTop = "4px";
        ul.style.marginBottom = "8px";
        if (rows.length === 0) {
          ul.innerHTML = "<li>Nessun dato</li>";
        } else {
          rows.slice(0,4).forEach((row, i) => {
            const li = document.createElement("li");
            li.textContent = `${i+1}. ${row.player}: ${row.pts}`;
            ul.appendChild(li);
          });
        }
        visualContainer.appendChild(ul);
      });

      const hHist = document.createElement("h3");
      hHist.textContent = "üìÖ Cronologia Punteggi";
      visualContainer.appendChild(hHist);
      
      const sourceTable = document.getElementById("table-history");
      if (sourceTable && sourceTable.rows.length > 0) {
        const tableWrap = document.createElement("div");
        tableWrap.style.overflowX = "auto";
        tableWrap.style.marginBottom = "16px";
        const clonedTable = sourceTable.cloneNode(true);
        clonedTable.style.width = "100%";
        clonedTable.style.fontSize = "14px";
        tableWrap.appendChild(clonedTable);
        visualContainer.appendChild(tableWrap);
      } else {
        const p = document.createElement("p");
        p.textContent = "Nessun dato";
        visualContainer.appendChild(p);
      }

      const hStats = document.createElement("h3");
      hStats.textContent = "üìà Statistica Punteggi";
      visualContainer.appendChild(hStats);
      const ulStats = document.createElement("ul");
      if (scoreCounts) {
        Object.keys(scoreCounts).forEach(k => {
          const li = document.createElement("li");
          li.textContent = `${k}: ${scoreCounts[k]}`;
          ulStats.appendChild(li);
        });
      }
      visualContainer.appendChild(ulStats);

      showReportDialog(visualContainer, text);
    }

    function showReportDialog(content, textForClipboard) {
      const actions = document.createElement("div");
      actions.className = "row";
      const copyBtn = document.createElement("button");
      copyBtn.className = "btn success";
      copyBtn.textContent = "Copia testo";
      copyBtn.onclick = () => {
        function legacyCopy() {
          return new Promise((resolve, reject) => {
            const ta = document.createElement("textarea");
            ta.value = textForClipboard;
            ta.style.position = "fixed";
            ta.style.top = "-1000px";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            try {
              const ok = document.execCommand("copy");
              document.body.removeChild(ta);
              ok ? resolve() : reject();
            } catch (e) {
              document.body.removeChild(ta);
              reject(e);
            }
          });
        }
        const canClipboard = !!(navigator.clipboard && navigator.clipboard.writeText);
        const p = canClipboard ? navigator.clipboard.writeText(textForClipboard) : legacyCopy();
        p.then(() => {
          alert("Testo copiato (la tabella colorata non pu√≤ essere copiata come testo)");
        }).catch(() => {
          alert("Impossibile copiare il testo");
        });
      };
      const waBtn = document.createElement("a");
      waBtn.className = "btn primary";
      waBtn.textContent = "Apri WhatsApp Web";
      waBtn.target = "_blank";
      waBtn.href = "https://api.whatsapp.com/send?text=" + encodeURIComponent(textForClipboard);
      const dlg = document.createElement("div");
      dlg.className = "panel";
      
      const contentBox = document.createElement("div");
      contentBox.style.maxHeight = "60vh";
      contentBox.style.overflowY = "auto";
      contentBox.style.background = "#0b1528";
      contentBox.style.padding = "10px";
      contentBox.style.borderRadius = "8px";
      contentBox.style.marginBottom = "10px";
      
      if (typeof content === "string") {
        const pre = document.createElement("pre");
        pre.textContent = content;
        pre.style.whiteSpace = "pre-wrap";
        contentBox.appendChild(pre);
      } else {
        contentBox.appendChild(content);
      }

      const hint = document.createElement("div");
      hint.className = "muted";
      hint.style.fontSize = "12px";
      hint.style.marginBottom = "10px";
      hint.style.fontStyle = "italic";
      hint.textContent = "Nota: Per condividere la tabella colorata, fai uno screenshot di questa finestra. I pulsanti sotto copiano solo il testo.";

      const closeBtn = document.createElement("button");
      closeBtn.className = "btn";
      closeBtn.textContent = "Chiudi";
      closeBtn.onclick = () => {
        dlg.remove();
      };
      
      dlg.appendChild(contentBox);
      dlg.appendChild(hint);
      dlg.appendChild(actions);
      actions.appendChild(copyBtn);
      actions.appendChild(waBtn);
      dlg.appendChild(closeBtn);
      document.body.appendChild(dlg);
      dlg.style.position = "fixed";
      dlg.style.right = "16px";
      dlg.style.bottom = "16px";
      dlg.style.maxWidth = "560px";
      dlg.style.maxHeight = "90vh";
      dlg.style.zIndex = "100";
      dlg.style.boxShadow = "0 0 20px rgba(0,0,0,0.5)";
      dlg.style.border = "1px solid var(--accent2)";
    }

    function openReportModal(serata) {
      const c = countPointsForSerata(serata);
      const w = eveningWinner(serata);
      const d = parseDateInput(serata.date);
      const dateStr = d ? d.toLocaleDateString("it-IT") : serata.date;
      const lines = [];
      lines.push(`üÉè Serata del ${dateStr}`);
      lines.push(`${pairLabel(serata.pairA)} vs ${pairLabel(serata.pairB)}`);
      lines.push(`Risultato: ${c.A} - ${c.B}`);
      lines.push(`Giochi:`);
      serata.games.forEach(g => {
        const winPair = g.winner === "A" ? pairLabel(serata.pairA) : pairLabel(serata.pairB);
        lines.push(`- ${g.name}: ${winPair}`);
      });
      if (w) {
        const winPair = w === "A" ? pairLabel(serata.pairA) : pairLabel(serata.pairB);
        lines.push(`üèÜ Vincitori: ${winPair}`);
      }
      const text = lines.join("\n");
      showReportDialog(text, text);
    }

    document.getElementById("btn-stats-report").addEventListener("click", openStatsReportModal);

    setActiveTab("home");
  </script>
</body>
</html>